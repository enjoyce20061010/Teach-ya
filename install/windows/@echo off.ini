@echo off
chcp 65001 >nul
title UI CoreWork 安裝程式

echo ===============================================
echo     🚀 UI CoreWork 安裝程式
echo ===============================================
echo.

set "ERROR_FLAG=0"

REM 檢查管理員權限（如果需要安裝到 Program Files）
net session >nul 2>&1
if %errorlevel% neq 0 (
    echo 警告: 建議使用管理員權限執行此安裝程式
    echo.
)

REM 檢查 Python
echo [1/6] 檢查 Python 環境...
python --version >nul 2>&1
if errorlevel 1 (
    echo ❌ 未找到 Python，正在下載安裝...
    echo 正在下載 Python 3.11.5...
    bitsadmin /transfer "PythonDL" /download /priority normal "https://www.python.org/ftp/python/3.11.5/python-3.11.5-amd64.exe" "%CD%\python-installer.exe"
    if errorlevel 1 (
        echo ❌ Python 下載失敗
        echo 請手動下載 Python 3.11.5 並安裝:
        echo 網址: https://www.python.org/ftp/python/3.11.5/python-3.11.5-amd64.exe
        set "ERROR_FLAG=1"
        goto :ERROR_HANDLER
    )

    REM 安裝 Python
    echo 正在安裝 Python...
    start /wait python-installer.exe /quiet InstallAllUsers=1 PrependPath=1 Include_test=0
    if errorlevel 1 (
        echo ❌ Python 安裝失敗
        set "ERROR_FLAG=1"
        goto :ERROR_HANDLER
    )
    
    REM 刪除安裝程序
    del python-installer.exe
    
    echo ✅ Python 安裝完成
) else (
    echo ✅ Python 已安裝
)

REM 重新檢查 Python 路徑
python --version >nul 2>&1
if errorlevel 1 (
    echo ❌ 請重新啟動終端機或將 Python 添加到 PATH
    set "ERROR_FLAG=1"
    goto :ERROR_HANDLER
)

REM 建立虛擬環境
echo.
echo [2/6] 建立虛擬環境...
if exist venv (
    echo ⚠ 虛擬環境已存在，重新建立...
    rmdir /s /q venv >nul 2>&1
)

python -m venv venv
if errorlevel 1 (
    echo ❌ 虛擬環境建立失敗
    set "ERROR_FLAG=1"
    goto :ERROR_HANDLER
)
echo ✅ 虛擬環境建立成功

REM 啟動虛擬環境
echo.
echo [3/6] 啟動虛擬環境...
call venv\Scripts\activate.bat
if errorlevel 1 (
    echo ❌ 虛擬環境啟動失敗
    set "ERROR_FLAG=1"
    goto :ERROR_HANDLER
)

REM 升級 pip
echo.
echo [4/6] 安裝專案依賴...
python -m pip install --upgrade pip >nul 2>&1

if not exist "backend\requirements.txt" (
    echo ❌ 找不到 requirements.txt 文件
    set "ERROR_FLAG=1"
    goto :ERROR_HANDLER
)

echo 安裝依賴包...
pip install -r backend\requirements.txt
if errorlevel 1 (
    echo ❌ 依賴安裝失敗
    set "ERROR_FLAG=1"
    goto :ERROR_HANDLER
)
echo ✅ 依賴安裝完成

REM 初始化資料庫
echo.
echo [5/6] 初始化資料庫...
if not exist "database\init_db.py" (
    echo ❌ 找不到資料庫初始化腳本
    set "ERROR_FLAG=1"
    goto :ERROR_HANDLER
)

cd database
python init_db.py create
if errorlevel 1 (
    echo ❌ 資料庫初始化失敗
    cd ..
    set "ERROR_FLAG=1"
    goto :ERROR_HANDLER
)
cd ..
echo ✅ 資料庫初始化完成

REM 建立桌面捷徑
echo.
echo [6/6] 建立桌面捷徑...
set "SHORTCUT_PATH=%USERPROFILE%\Desktop\UI CoreWork.lnk"

if exist "%SHORTCUT_PATH%" (
    echo ⚠ 捷徑已存在，重新建立...
    del "%SHORTCUT_PATH%" >nul 2>&1
)

echo Set oWS = WScript.CreateObject("WScript.Shell") > CreateShortcut.vbs
echo sLinkFile = "%SHORTCUT_PATH%" >> CreateShortcut.vbs
echo Set oLink = oWS.CreateShortcut(sLinkFile) >> CreateShortcut.vbs
echo oLink.TargetPath = "%CD%\start_windows.bat" >> CreateShortcut.vbs
echo oLink.WorkingDirectory = "%CD%" >> CreateShortcut.vbs
echo oLink.Description = "UI CoreWork" >> CreateShortcut.vbs
echo oLink.IconLocation = "%CD%\venv\Scripts\python.exe, 0" >> CreateShortcut.vbs
echo oLink.Save >> CreateShortcut.vbs

cscript //nologo CreateShortcut.vbs >nul 2>&1
if errorlevel 1 (
    echo ⚠ 捷徑建立失敗（可能權限不足）
) else (
    echo ✅ 桌面捷徑建立完成
)
del CreateShortcut.vbs >nul 2>&1

REM 建立啟動腳本（如果不存在）
if not exist "start_windows.bat" (
    echo @echo off > start_windows.bat
    echo chcp 65001 >nul >> start_windows.bat
    echo title UI CoreWork >> start_windows.bat
    echo call venv\Scripts\activate.bat >> start_windows.bat
    echo python backend\main.py >> start_windows.bat
    echo pause >> start_windows.bat
)

REM 安裝完成，自動啟動應用
echo.
echo ===============================================
echo         ✅ 安裝完成！
echo ===============================================
echo.
echo 📍 服務器地址: http://localhost:8000
echo 📍 桌面捷徑: UI CoreWork.lnk
echo 📍 啟動腳本: start_windows.bat
echo.
echo 🚀 正在啟動應用程式...
echo ===============================================

timeout /t 3 /nobreak >nul

REM 開啟瀏覽器
start "" "http://localhost:8000" >nul 2>&1

REM 啟動後端服務（新視窗執行）
start "UI CoreWork" cmd /k call "%~dp0venv\Scripts\activate.bat" ^& python "%~dp0backend\main.py"

echo.
echo ===============================================
echo ✅ UI CoreWork 已啟動！
echo -----------------------------------------------
echo 📢 下次開機後，只需雙擊桌面上的捷徑：
echo      「UI CoreWork」
echo 即可重新啟動系統
echo ===============================================
timeout /t 5 >nul
exit /b 0

:ERROR_HANDLER
echo.
echo ===============================================
echo         ❌ 安裝過程中出現錯誤
echo ===============================================
echo.
if "%ERROR_FLAG%"=="1" (
    echo 請檢查以上錯誤信息，解決問題後重新執行安裝程式。
    echo.
    echo 常見問題解決方案:
    echo 1. 確保網路連接正常
    echo 2. 以管理員身份運行此腳本
    echo 3. 檢查防毒軟體是否攔截
    echo 4. 手動安裝 Python 3.11+
)
pause
exit /b 1
